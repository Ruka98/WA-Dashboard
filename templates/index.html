<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Accounting Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .dashboard-header {
            background-color: #1a5276;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #2980b9;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            font-weight: bold;
        }
        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        .chart-container {
            height: 100%;
            min-height: 400px;
            width: 100%;
        }
        .pie-chart-container {
            height: 400px;
            width: 100%;
        }
        .basin-selector {
            margin-bottom: 20px;
        }
        .year-selector {
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .btn-primary:hover {
            background-color: #1a5276;
            border-color: #1a5276;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        #loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .summary-container {
            margin-top: 20px;
        }
        .sankey-container {
            height: 500px;
        }
        .error-message {
            color: #dc3545;
            margin-bottom: 15px;
        }
        .highlighted-basin {
            fillColor: '#e74c3c';
            weight: 2;
            opacity: 1;
            color: '#c0392b';
            fillOpacity: 0.7;
        }
        .form-check-label {
            margin-left: 5px;
        }
        .no-data-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="loading-spinner">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-header text-center">
            <h1>Water Accounting Online</h1>
            <p class="lead">Visualizing water balance components for river basins</p>
        </div>

        {% if error_message %}
        <div class="alert alert-danger error-message">
            {{ error_message }}
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Basin Selection
                    </div>
                    <div class="card-body">
                        <form id="dashboard-form" method="POST" action="/">
                            <div class="basin-selector">
                                <label for="basin" class="form-label">Select Basin:</label>
                                <select class="form-select" id="basin" name="basin">
                                    <option value="">-- Select a Basin --</option>
                                    {% for basin in basins %}
                                        <option value="{{ basin }}" {% if basin == selected_basin %}selected{% endif %}>{{ basin }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="year-selector">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="year_start" class="form-label">Start Year:</label>
                                        <input type="number" class="form-control" id="year_start" name="year_start" 
                                               min="2000" max="{{ current_year }}" value="{{ year_start }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="year_end" class="form-label">End Year:</label>
                                        <input type="number" class="form-control" id="year_end" name="year_end" 
                                               min="2000" max="{{ current_year }}" value="{{ year_end }}">
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mt-3">Update Dashboard</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        Basin Map
                    </div>
                    <div class="card-body">
                        <div id="map" class="map-container"></div>
                        <input type="hidden" id="map_click_basin" name="map_click_basin">
                    </div>
                </div>
            </div>
        </div>

        {% if selected_basin %}
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        Water Balance Summary - {{ selected_basin }} ({% if is_single_year %}{{ year_start }}{% else %}{{ year_start }} - {{ year_end }}{% endif %})
                    </div>
                    <div class="card-body">
                        {% if water_balance_summary and water_balance_summary.html %}
                            {{ water_balance_summary.html|safe }}
                        {% else %}
                            <div class="no-data-message">No summary data available for the selected basin and time period.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Total ET Composition (Blue vs Green)
                    </div>
                    <div class="card-body">
                        <div id="total-et-pie-chart" class="pie-chart-container">
                            {% if not graphs_json.total_et_pie %}
                                <div class="no-data-message">No ET data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Water Input Composition
                    </div>
                    <div class="card-body">
                        <div id="input-pie-chart" class="pie-chart-container">
                            {% if not graphs_json.input_pie %}
                                <div class="no-data-message">No input data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        ET Rain Composition
                    </div>
                    <div class="card-body">
                        <div id="et-rain-pie-chart" class="pie-chart-container">
                            {% if not graphs_json.et_rain_pie %}
                                <div class="no-data-message">No ET Rain data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        ET Blue Composition
                    </div>
                    <div class="card-body">
                        <div id="et-blue-pie-chart" class="pie-chart-container">
                            {% if not graphs_json.et_blue_pie %}
                                <div class="no-data-message">No ET Blue data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Inflow Composition
                    </div>
                    <div class="card-body">
                        <div id="inflow-pie-chart" class="pie-chart-container">
                            {% if not graphs_json.inflow_pie %}
                                <div class="no-data-message">No inflow data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Outflow Composition
                    </div>
                    <div class="card-body">
                        <div id="outflow-pie-chart" class="pie-chart-container">
                            {% if not graphs_json.outflow_pie %}
                                <div class="no-data-message">No outflow data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Water Consumption
                    </div>
                    <div class="card-body">
                        <div id="consumption-bar-chart" class="chart-container">
                            {% if not graphs_json.consumption_bar %}
                                <div class="no-data-message">No consumption data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Water Flow Diagram
                    </div>
                    <div class="card-body">
                        <div id="sankey-diagram" class="sankey-container">
                            {% if not graphs_json.sankey %}
                                <div class="no-data-message">No flow data available for the selected basin and time period.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize map
        let map = L.map('map').setView([31.5, 36.0], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let geojsonLayer;
        let highlightedLayer = null;

        // Load basin GeoJSON data
        fetch('/get_all_basins')
            .then(response => response.json())
            .then(data => {
                if (data.geojson) {
                    geojsonLayer = L.geoJSON(data.geojson, {
                        style: function(feature) {
                            return {
                                fillColor: '#2980b9',
                                weight: 1,
                                opacity: 1,
                                color: 'white',
                                dashArray: '3',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties && feature.properties.basin_name) {
                                layer.bindPopup(`<b>${feature.properties.basin_name}</b>`);
                                layer.on('click', function(e) {
                                    document.getElementById('basin').value = feature.properties.basin_name;
                                    document.getElementById('map_click_basin').value = feature.properties.basin_name;
                                    highlightBasin(feature.properties.basin_name);
                                    document.getElementById('dashboard-form').submit();
                                });
                            }
                        }
                    }).addTo(map);
                    
                    // Fit map to bounds of all features
                    map.fitBounds(geojsonLayer.getBounds());

                    // If a basin is already selected, highlight it
                    {% if selected_basin %}
                        highlightBasin('{{ selected_basin }}');
                    {% endif %}
                }
            });

        function highlightBasin(basinName) {
            // Reset all basins to default style
            if (geojsonLayer) {
                geojsonLayer.setStyle({
                    fillColor: '#2980b9',
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                });

                // Remove previous highlight if exists
                if (highlightedLayer) {
                    geojsonLayer.removeLayer(highlightedLayer);
                }

                // Find and highlight the selected basin
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.feature.properties.basin_name === basinName) {
                        layer.setStyle({
                            fillColor: '#e74c3c',
                            weight: 2,
                            opacity: 1,
                            color: '#c0392b',
                            fillOpacity: 0.7
                        });
                        
                        // Zoom to the selected basin with a closer view
                        const bounds = layer.getBounds();
                        map.fitBounds(bounds, {
                            padding: [20, 20],
                            maxZoom: 12,
                            duration: 1
                        });
                        
                        // Keep reference to the highlighted layer
                        highlightedLayer = layer;
                    }
                });
            }
        }

        // Function to render a Plotly chart
        function renderChart(chartId, chartData) {
            if (chartData && chartData !== 'null' && chartData !== 'None') {
                try {
                    const figure = JSON.parse(chartData);
                    Plotly.newPlot(chartId, figure.data, figure.layout, {
                        responsive: true,
                        displayModeBar: true
                    });
                    console.log(`Rendered chart: ${chartId}`);
                } catch (e) {
                    console.error(`Error rendering chart ${chartId}:`, e);
                    document.getElementById(chartId).innerHTML = 
                        '<div class="no-data-message">Error displaying chart data</div>';
                }
            } else {
                console.log(`No data for chart: ${chartId}`);
            }
        }

        // Display charts if data exists
        document.addEventListener('DOMContentLoaded', function() {
            {% if graphs_json %}
                // Convert the JSON strings to JavaScript objects
                const graphsData = {
                    {% for key, value in graphs_json.items() %}
                        '{{ key }}': {{ value|tojson|safe }},
                    {% endfor %}
                };

                // Render each chart if data exists
                if (graphsData.total_et_pie) {
                    renderChart('total-et-pie-chart', graphsData.total_et_pie);
                }
                if (graphsData.et_rain_pie) {
                    renderChart('et-rain-pie-chart', graphsData.et_rain_pie);
                }
                if (graphsData.et_blue_pie) {
                    renderChart('et-blue-pie-chart', graphsData.et_blue_pie);
                }
                if (graphsData.input_pie) {
                    renderChart('input-pie-chart', graphsData.input_pie);
                }
                if (graphsData.inflow_pie) {
                    renderChart('inflow-pie-chart', graphsData.inflow_pie);
                }
                if (graphsData.outflow_pie) {
                    renderChart('outflow-pie-chart', graphsData.outflow_pie);
                }
                if (graphsData.consumption_bar) {
                    renderChart('consumption-bar-chart', graphsData.consumption_bar);
                }
                if (graphsData.sankey) {
                    renderChart('sankey-diagram', graphsData.sankey);
                }
            {% endif %}

            // Show loading spinner on form submission
            document.getElementById('dashboard-form').addEventListener('submit', function() {
                document.getElementById('loading-spinner').style.display = 'flex';
            });

            // Update end year when start year changes to ensure it's not before start year
            document.getElementById('year_start').addEventListener('change', function() {
                const startYear = parseInt(this.value);
                const endYearInput = document.getElementById('year_end');
                const endYear = parseInt(endYearInput.value);
                
                if (startYear > endYear) {
                    endYearInput.value = startYear;
                }
            });

            // Highlight basin when selected from dropdown
            document.getElementById('basin').addEventListener('change', function() {
                if (this.value) {
                    highlightBasin(this.value);
                }
            });
        });
    </script>
</body>
</html>